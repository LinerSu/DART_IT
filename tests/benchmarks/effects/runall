#!/usr/bin/perl

my $MOCHIDIR = '/tools/ejk/MoCHi/';
my $DRIFTDIR = '/tools/ejk/drift';
my $BENCHDIR = $DRIFTDIR.'/tests/benchmarks/effects';
#my @BENCHES = qw/3states.ml/;
opendir my $dir, $BENCHDIR or die "Cannot open directory: $!";
my @BENCHES = readdir $dir;
closedir $dir;

sub execute {
    my ($cmd) = @_;
    print "CMD: $cmd\n";
    my $out = qx{$cmd};
    print "OUT: $out\n";
    return $out;
}


my $res;
foreach my $b (@BENCHES) {
    next unless $b =~ /foo-nondet\.ml$/;
    push @done_benches, $b;
    print "Benchmark: $b\n";
    chdir($MOCHIDIR);
    my $out = execute qq(./src/mochi.exe $BENCHDIR/$b);
    $res->{$b}->{mochi}->{result} = ($out =~ /Safe\!/ ? 'safe' : ($out =~ /Unsafe\!/ ? 'unsafe' : 'unknown'));
    $res->{$b}->{mochi}->{time} = ($out =~ /total: (\d+\.\d+) / ? $1 : 'unparsed');

    # Drift
    chdir($DRIFTDIR);
    $out = execute qq(./drift.native -file $BENCHDIR/$b -domain FinVal);
    $res->{$b}->{drift}->{result} = ($out =~ /The program is safe/ ? 'safe' :
                                          ($out =~ /The program may not be safe/ ? 'unsafe' :
                                          'unparsed'));
}

use Data::Dumper;
print Dumper($res);

print "\n\nBenchmark      & Mochi result & Mochi time & Drift result & Drift time\\\\\n";
foreach my $b (@done_benches) {
    printf("%-20s & %s & %03.1f s & %s & %03.1f \\\\\n",
       $b, 
       $res->{$b}->{mochi}->{result},
       $res->{$b}->{mochi}->{time},
       "todo",
       0
    );
}
print "\n";